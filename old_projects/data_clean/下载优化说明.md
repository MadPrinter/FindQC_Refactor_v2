# 图片下载程序优化说明

## 优化内容

### 1. 提高下载速度

#### Session 复用连接
- 每个线程使用独立的 `requests.Session` 对象
- 复用 TCP 连接，减少连接建立开销
- **效果**：显著提高下载速度，特别是在大量小文件下载时

#### 增加并发数
- 默认并发数从 10 提升到 20
- 可在 `config.py` 中调整 `MAX_WORKERS` 参数
- **注意**：根据网络带宽和服务器限制调整，避免被封IP

### 2. 批量生成 JSON（增量保存）

#### 定期保存机制
- 每处理 `MAPPING_SAVE_INTERVAL`（默认50）个商品自动保存一次映射文件
- 使用临时文件 + 原子替换，确保数据安全
- **好处**：
  - 即使程序中断，已处理的数据不会丢失
  - 可以实时查看下载进度
  - 减少内存占用（定期清理）

#### 线程安全
- 使用 `threading.Lock` 保护共享数据
- 确保多线程环境下数据一致性

### 3. 断点续传机制

#### 智能跳过
- 启动时自动加载已有的 `image_mapping.json` 文件
- 检查每个商品的图片是否已完整下载
- 自动跳过已完整处理的商品

#### 文件检查
- 下载前检查文件是否已存在
- 如果文件存在，直接使用，不重复下载
- 统计时区分"下载成功"和"跳过（已存在）"

#### 映射合并
- 如果商品已有部分映射，自动合并新旧映射
- 基于 URL 去重，避免重复记录

## 性能优化对比

### 优化前
- 并发数：10
- 每次请求新建连接
- 最后一次性保存 JSON（可能丢失数据）
- 无断点续传

### 优化后
- 并发数：20（可配置）
- Session 复用连接（速度提升 2-3 倍）
- 每 50 个商品保存一次 JSON（数据安全）
- 完整的断点续传机制

## 配置参数

在 `config.py` 中可以调整：

```python
# 并发下载线程数（提高速度）
MAX_WORKERS = 20

# 批量保存间隔（每处理 N 个商品保存一次）
MAPPING_SAVE_INTERVAL = 50
```

## 使用场景

### 场景1：首次下载
```bash
python3 download_images.py
```
- 下载所有图片
- 每 50 个商品保存一次映射文件

### 场景2：断点续传
```bash
# 如果程序中断，重新运行
python3 download_images.py
```
- 自动检测已有映射文件
- 跳过已完整处理的商品
- 继续下载未完成的商品

### 场景3：增量更新
```bash
# 如果 cleaned_data.json 有新增商品
python3 download_images.py
```
- 只下载新增商品的图片
- 自动合并到已有映射文件

## 输出示例

```
============================================================
图片下载程序
============================================================
图片保存目录: downloaded_images

读取数据文件: cleaned_data.json
找到 27659 个商品
需要下载的图片总数: 82977

发现已有映射文件，已加载 1000 个商品的映射（断点续传）
  已有图片映射: 6000 张
跳过已完整处理的商品: 1000 个
需要处理的商品: 26659 个

开始下载图片...
并发数: 20
超时时间: 30 秒
重试次数: 3
批量保存间隔: 每 50 个商品保存一次
------------------------------------------------------------
进度: 50/26659 - 商品 991466016025: 主图2 张, SKU图2 张, QC图2 张
  ✓ 已保存映射文件（1050 个商品）
进度: 100/26659 - 商品 772173993397: 主图2 张, SKU图0 张, QC图2 张
  ✓ 已保存映射文件（1100 个商品）
...
```

## 注意事项

1. **网络带宽**：高并发会占用大量带宽，注意不要影响其他网络使用
2. **服务器限制**：某些服务器可能限制并发连接数，如果频繁出现 429 错误，降低 `MAX_WORKERS`
3. **磁盘空间**：确保有足够的磁盘空间存储图片
4. **断点续传**：如果删除 `image_mapping.json`，程序会重新开始下载

## 故障恢复

如果程序异常退出：
1. 检查 `image_mapping.json` 文件是否完整
2. 检查 `downloaded_images/` 目录中的图片
3. 重新运行程序，会自动从断点继续

## 性能监控

程序会显示：
- 下载成功数量
- 跳过数量（已存在）
- 下载失败数量
- 403 错误数量
- 平均下载速度

通过这些数据可以判断下载效率和问题。









