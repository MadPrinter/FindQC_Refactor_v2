# 程序中断保护功能说明

## 功能概述

`download_images.py` 现在支持程序中断保护功能。当程序被中断（如按 Ctrl+C）时，会自动保存：
1. 已完成的商品映射数据
2. 未完成的任务列表

下次运行程序时，会自动恢复未完成的任务，继续下载。

## 工作原理

### 1. 信号处理
- 监听 `SIGINT`（Ctrl+C）和 `SIGTERM`（终止信号）
- 收到中断信号时，触发优雅关闭流程

### 2. 优雅关闭流程
1. 设置关闭标志，停止接受新任务
2. 等待当前正在执行的任务完成（最多2秒）
3. 保存已完成的商品映射到 `image_mapping.json`
4. 保存未完成的任务到 `pending_tasks.json`
5. 安全退出程序

### 3. 任务恢复
- 下次启动时，自动检测 `pending_tasks.json`
- 如果存在，优先处理未完成的任务
- 处理完成后自动删除待办文件

## 使用场景

### 场景1：正常中断（Ctrl+C）
```bash
# 运行程序
python3 download_images.py

# 按 Ctrl+C 中断
^C
收到中断信号，正在安全退出...
等待当前任务完成...
保存当前进度...
✓ 映射文件已保存: 1000 个商品
✓ 未完成任务已保存: 500 个商品
  文件位置: pending_tasks.json
  下次运行时会自动恢复这些任务

✓ 数据已安全保存，程序退出
```

### 场景2：恢复未完成任务
```bash
# 再次运行程序
python3 download_images.py

发现未完成任务: 500 个商品
  将优先处理这些任务
开始下载图片...
```

### 场景3：所有任务完成
```bash
# 所有任务完成后
映射文件已保存: image_mapping.json (共 1500 个商品)
✓ 所有任务已完成，已删除待办文件
```

## 文件说明

### `pending_tasks.json`
- 存储未完成的任务列表
- 格式：JSON 数组，每个元素是一个商品数据字典
- 位置：`data_clean/pending_tasks.json`
- 自动管理：任务完成后自动删除

### `image_mapping.json`
- 存储已完成的商品映射
- 每次批量保存和程序退出时都会更新
- 支持断点续传

## 特性

### 1. 线程安全
- 使用锁保护共享数据
- 确保多线程环境下数据一致性

### 2. 原子操作
- 使用临时文件 + 重命名确保文件完整性
- 避免写入过程中的数据损坏

### 3. 自动恢复
- 无需手动操作
- 下次启动自动检测并恢复

### 4. 优先级处理
- 未完成任务优先处理
- 确保中断的任务尽快完成

## 注意事项

1. **不要手动删除 `pending_tasks.json`**
   - 如果手动删除，未完成的任务将丢失
   - 程序会自动管理这个文件

2. **中断后立即重启**
   - 建议中断后尽快重启程序
   - 避免长时间未处理导致任务丢失

3. **多次中断**
   - 支持多次中断和恢复
   - 每次中断都会更新未完成任务列表

4. **任务去重**
   - 程序会自动跳过已完成的商品
   - 避免重复下载

## 示例输出

### 中断时的输出
```
进度: 1000/1500 - 商品 991466016025: 主图2 张, SKU图2 张, QC图2 张 (共6张)
^C

============================================================
收到中断信号，正在安全退出...
============================================================
等待当前任务完成...
保存当前进度...
✓ 映射文件已保存: 1000 个商品
✓ 未完成任务已保存: 500 个商品
  文件位置: pending_tasks.json
  下次运行时会自动恢复这些任务

✓ 数据已安全保存，程序退出
============================================================
```

### 恢复时的输出
```
============================================================
图片下载程序
============================================================
...
发现未完成任务: 500 个商品
  将优先处理这些任务
开始下载图片...
```

## 技术细节

### 信号处理
```python
signal.signal(signal.SIGINT, signal_handler)   # Ctrl+C
signal.signal(signal.SIGTERM, signal_handler)  # 终止信号
```

### 关闭标志
```python
_shutdown_flag = threading.Event()  # 线程安全的事件标志
```

### 任务跟踪
```python
completed_items = set()  # 已完成的商品ID集合
_pending_items = []      # 未完成的任务列表
```

## 故障排除

### 问题1：中断后未完成任务丢失
- 检查 `pending_tasks.json` 是否存在
- 检查文件权限
- 查看错误日志

### 问题2：恢复后重复下载
- 检查 `image_mapping.json` 是否正确
- 检查商品ID是否匹配

### 问题3：中断后无法恢复
- 检查 `pending_tasks.json` 格式是否正确
- 尝试手动删除文件，重新开始









