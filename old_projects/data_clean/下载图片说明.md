# 图片下载程序使用说明

## 功能说明

`download_images.py` 用于从 `cleaned_data.json` 中读取图片 URL，批量下载到本地文件夹，并生成图片映射 JSON 文件。

## 主要功能

1. **读取数据**：从 `cleaned_data.json` 读取商品数据
2. **下载图片**：下载所有商品的 `mainImages`、`skuImages`、`qcImages`
3. **组织存储**：按类型分类保存到不同文件夹
4. **生成映射**：创建 `image_mapping.json`，关联 `itemId` 和本地图片路径

## 目录结构

下载后的目录结构：

```
downloaded_images/
├── main/          # 主图
│   ├── {itemId}_main_0_{hash}.jpg
│   └── ...
├── sku/           # SKU图
│   ├── {itemId}_sku_0_{hash}.jpg
│   └── ...
└── qc/            # QC图
    ├── {itemId}_qc_0_{hash}.jpg
    └── ...

image_mapping.json  # 图片映射文件
```

## 映射文件格式

`image_mapping.json` 的格式示例：

```json
[
  {
    "itemId": "991466016025",
    "mainImages": [
      {
        "url": "https://img.alicdn.com/bao/uploaded/i4/...",
        "localPath": "main/991466016025_main_0_abc12345.jpg",
        "filename": "991466016025_main_0_abc12345.jpg"
      }
    ],
    "skuImages": [
      {
        "url": "https://img.alicdn.com/bao/uploaded/i3/...",
        "localPath": "sku/991466016025_sku_0_def67890.png",
        "filename": "991466016025_sku_0_def67890.png"
      }
    ],
    "qcImages": [
      {
        "url": "https://qc.findqc.com/qcimage/...",
        "localPath": "qc/991466016025_qc_0_ghi11111.jpg",
        "filename": "991466016025_qc_0_ghi11111.jpg"
      }
    ]
  }
]
```

## 使用方法

### 1. 基本使用

```bash
cd /Users/100buy/新链路/data_clean
source venv/bin/activate
python3 download_images.py
```

### 2. 配置参数

在 `config.py` 中可以配置以下参数：

```python
# 输入数据文件
INPUT_DATA_FILE = Path("cleaned_data.json")

# 图片保存目录
IMAGES_DIR = Path("downloaded_images")

# 映射文件路径
IMAGE_MAPPING_FILE = Path("image_mapping.json")

# 下载配置
MAX_WORKERS = 10          # 并发下载线程数
DOWNLOAD_TIMEOUT = 30     # 下载超时时间（秒）
RETRY_TIMES = 3           # 失败重试次数
RETRY_DELAY = 1           # 重试延迟（秒）
```

## 特性

### 1. 并发下载
- 使用线程池并发下载，提高效率
- 默认 10 个并发线程，可在配置中调整

### 2. 智能重试
- 下载失败自动重试（默认 3 次）
- 重试间隔递增（1秒、2秒、3秒）

### 3. 文件命名
- 文件名格式：`{itemId}_{imageType}_{index}_{hash}.{ext}`
- 使用 URL 哈希值确保唯一性
- 自动识别图片扩展名

### 4. 跳过已下载
- 如果文件已存在，自动跳过下载
- 支持断点续传

### 5. 进度显示
- 实时显示下载进度
- 显示每个商品的图片下载情况

## 输出信息

程序运行时会显示：

```
============================================================
图片下载程序
============================================================
图片保存目录: downloaded_images
读取数据文件: cleaned_data.json
找到 1000 个商品
需要下载的图片总数: 6000

开始下载图片...
并发数: 10
超时时间: 30 秒
重试次数: 3
------------------------------------------------------------
进度: 100/1000 - 商品 991466016025: 主图2 张, SKU图2 张, QC图2 张
...

============================================================
下载完成！
============================================================
总商品数: 1000
成功处理: 1000 个商品
下载成功: 6000 张图片
处理失败: 0 个商品
总耗时: 120.50 秒
平均速度: 49.79 张/秒

图片类型统计:
  主图: 2000 张
  SKU图: 2000 张
  QC图: 2000 张
```

## 注意事项

1. **网络连接**：确保网络连接稳定，下载大量图片需要时间
2. **磁盘空间**：确保有足够的磁盘空间存储图片
3. **下载速度**：可以根据网络情况调整 `MAX_WORKERS` 参数
4. **断点续传**：如果下载中断，重新运行程序会跳过已下载的图片

## 故障排除

### 问题1：下载失败
- 检查网络连接
- 增加 `RETRY_TIMES` 重试次数
- 增加 `DOWNLOAD_TIMEOUT` 超时时间

### 问题2：下载速度慢
- 增加 `MAX_WORKERS` 并发数（注意不要过大，避免被封IP）
- 检查网络带宽

### 问题3：磁盘空间不足
- 清理磁盘空间
- 或修改 `IMAGES_DIR` 到其他位置

## 依赖

需要安装 `requests` 库：

```bash
pip install requests
```

或安装所有依赖：

```bash
pip install -r requirements.txt
```

