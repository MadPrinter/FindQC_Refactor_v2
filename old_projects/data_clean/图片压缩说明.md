# 图片压缩功能说明

## 功能概述

为了节省大模型输入时的 token 消耗，图片下载程序支持三种压缩模式，可以在下载时自动压缩图片。

## 三种压缩模式

### 1. 极致节省模式（minimal）
- **最大尺寸**: 512px
- **JPEG 质量**: 75%
- **预估节省**: ~90% token
- **适用场景**: 对图片质量要求不高，追求最小 token 消耗

### 2. 平衡模式（balanced）- 默认推荐
- **最大尺寸**: 1024px
- **JPEG 质量**: 80%
- **预估节省**: ~80% token
- **适用场景**: 平衡图片质量和 token 消耗，推荐使用

### 3. 高质量模式（high_quality）
- **最大尺寸**: 1536px
- **JPEG 质量**: 85%
- **预估节省**: ~60% token
- **适用场景**: 对图片质量要求较高，但仍需节省 token

## 配置方法

在 `config.py` 中修改以下配置：

```python
# 压缩模式选择: 'minimal', 'balanced', 'high_quality'
COMPRESSION_MODE = 'balanced'  # 修改这里切换模式

# 是否启用图片压缩
ENABLE_IMAGE_COMPRESSION = True  # False 则禁用压缩

# 是否转换为 WebP 格式（更小的文件大小）
CONVERT_TO_WEBP = False  # 注意：某些模型可能不支持 WebP

# 是否保留原始文件
KEEP_ORIGINAL = False  # True 则原图保存到 original/ 目录
```

## 使用示例

### 切换到极致节省模式
```python
COMPRESSION_MODE = 'minimal'
ENABLE_IMAGE_COMPRESSION = True
```

### 切换到高质量模式
```python
COMPRESSION_MODE = 'high_quality'
ENABLE_IMAGE_COMPRESSION = True
```

### 禁用压缩
```python
ENABLE_IMAGE_COMPRESSION = False
```

## Token 节省效果

假设原始图片：
- 尺寸: 2000x2000px
- 大小: ~500KB
- Token: ~500 tokens（估算）

### 极致节省模式
- 尺寸: 512x512px
- 大小: ~50KB
- Token: ~50 tokens
- **节省: 90%**

### 平衡模式
- 尺寸: 1024x1024px
- 大小: ~100KB
- Token: ~100 tokens
- **节省: 80%**

### 高质量模式
- 尺寸: 1536x1536px
- 大小: ~200KB
- Token: ~200 tokens
- **节省: 60%**

## 压缩特性

1. **保持宽高比**: 压缩时自动保持图片原始宽高比
2. **格式转换**: 自动将 RGBA、P 等格式转换为 RGB
3. **白色背景**: 透明图片自动添加白色背景
4. **优化保存**: 使用 JPEG optimize 选项进一步减小文件大小

## 注意事项

1. **WebP 兼容性**: 如果启用 `CONVERT_TO_WEBP = True`，请先确认你的大模型是否支持 WebP 格式
2. **质量测试**: 建议先用小批量图片测试，确认压缩后的质量满足需求
3. **原图备份**: 如果需要保留原图，设置 `KEEP_ORIGINAL = True`，原图会保存到 `downloaded_images/original/` 目录
4. **处理时间**: 压缩会增加处理时间，但可以并行处理，影响较小

## 运行示例

运行下载程序时，会显示当前压缩配置：

```
开始下载图片...
并发数: 100
超时时间: 20 秒
重试次数: 3
批量保存间隔: 每 50 个商品保存一次

图片压缩配置:
  模式: balanced - 平衡模式（推荐，质量与大小平衡）
  最大尺寸: 1024px
  JPEG 质量: 80%
  转换为 WebP: 否
  保留原图: 否
------------------------------------------------------------
```

## 自定义模式

如果需要自定义压缩参数，可以直接修改 `COMPRESSION_MODES` 字典：

```python
COMPRESSION_MODES = {
    'custom': {
        'max_size': 800,      # 自定义尺寸
        'quality': 78,        # 自定义质量
        'description': '自定义模式'
    }
}
COMPRESSION_MODE = 'custom'
```









